SELECT custid as "customer ID", f.bs as "total books" FROM (SELECT a.custid, a.ptype, a.sum as bs, c.sum as ts FROM (SELECT custid, ptype, sum(qty) FROM customers JOIN orders ON customers.custid=orders.ocust JOIN details ON orders.ordid=details.ordid JOIN products ON details.pcode=products.pcode GROUP BY custid,ptype HAVING ptype='BOOK') as a JOIN (SELECT custid, sum(sum) FROM (SELECT custid, ptype, sum(qty) FROM customers JOIN orders ON customers.custid=orders.ocust JOIN details ON orders.ordid=details.ordid JOIN products ON details.pcode=products.pcode GROUP BY custid, ptype HAVING ptype<>'BOOK') as b GROUP BY b.custid) as c  ON a.custid=c.custid) as f WHERE f.bs>f.ts*2 ORDER BY custid;
