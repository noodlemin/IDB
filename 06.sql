SELECT pcode as "product code", "times ordered" FROM (SELECT *, a.sum as "times ordered", CAST(a.sum-(b.sum-a.sum)*1.5/(b.count-1) AS NUMERIC) AS judgement FROM(SELECT products.pcode, ptype, sum(qty) FROM products JOIN details ON products.pcode=details.pcode GROUP BY products.pcode ORDER BY products.ptype) AS a JOIN (SELECT ptype, sum(qty), count(qty) FROM products JOIN details ON products.pcode=details.pcode GROUP BY ptype) AS b ON a.ptype= b.ptype) as c WHERE judgement >=0;
