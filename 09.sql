SELECT "customer ID", "customer name", count AS "total orders" FROM (SELECT custid AS "customer ID", cname AS "customer name" FROM (SELECT custid, cname, avg(interv) FROM (SELECT custid, cname, d1, MIN(diff) AS interv FROM (SELECT custid, cname, b.odate AS d1, c.odate AS d2, c.odate-b.odate AS diff From (SELECT custid, cname FROM customers WHERE custid not in (select a.ocust from orders as a join orders as b on a.ocust=b.ocust and a.odate=b.odate and a.ordid<>b.ordid group by a.ocust) and custid in (Select ocust from (select ocust, count(ordid) from orders group by ocust) as a where count>9)) as a JOIN orders as b ON custid=b.ocust JOIN orders as c ON custid=c.ocust WHERE c.odate-b.odate>0 order by custid, b.odate, c.odate) as t GROUP BY custid,cname,d1 ORDER BY custid,d1) AS t GROUP BY custid, cname) as t WHERE avg < 7) as t JOIN (SELECT ocust, count(ordid) FROM orders GROUP BY ocust) as tt ON "customer ID"=ocust;
