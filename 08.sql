SELECT cid AS "customer ID", MAX(v) AS "number of days" FROM (SELECT cid, d1, MIN(diff) AS v FROM (SELECT a.ordid AS "ao", b.ordid AS "bo", a.ocust AS "cid", a.odate AS "d1", b.odate AS "d2", b.odate-a.odate AS diff FROM orders AS a JOIN orders AS b ON a.ocust=b.ocust AND a.odate<=b.odate AND a.ordid<>b.ordid ORDER BY a.ocust, a.odate, b.odate) AS t GROUP BY d1,cid ORDER BY cid) AS t GROUP BY cid ORDER BY cid;